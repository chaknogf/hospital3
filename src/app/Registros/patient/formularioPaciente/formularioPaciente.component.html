<div class="formulario-paciente">
  <!-- Campo trampa para evitar autocompletado real -->
<input type="text" name="fakeusernameremembered" style="display: none;" />
<input type="password" name="fakepasswordremembered" style="display: none;" />
  <h2>{{ enEdicion ? 'Editar Paciente' : 'Nuevo Paciente' }}</h2>

  <!-- Identificadores -->
 <fieldset>
  <legend>Identificadores</legend>

  <label for="cui">CUI</label>
 <input
  id="cui"
  type="text"
  [(ngModel)]="patient.identificadores[0].valor"
  name="cui"
  placeholder="Ingresa el n√∫mero de CUI"
  validarDPI
  [identificadorTipo]="patient.identificadores[0].tipo"
  maxlength="13"
  required
/>
<div *ngIf="patient.identificadores[0].valor?.length !== 13" class="input-error-msg">
  El CUI debe tener exactamente 13 d√≠gitos.
</div>


  <label for="expediente">Expediente</label>
  <input
    id="expediente"
    type="text"
    [(ngModel)]="patient.identificadores[1].valor"
    name="expediente"
    placeholder="Ingresa el n√∫mero de expediente"
    required
  />
</fieldset>

  <!-- Nombre -->
  <fieldset>
    <legend>Nombre</legend>
    <input [(ngModel)]="patient.nombre.primer" placeholder="Primer nombre" name="nombre1" unaPalabra autocomplete="new-name" />
    <input [(ngModel)]="patient.nombre.segundo" placeholder="Segundo nombre" name="nombre2" unaPalabra autocomplete="new-name" />
    <input [(ngModel)]="patient.nombre.otro" placeholder="Otro nombre" name="nombre3" *ngIf="patient.nombre.segundo" autocomplete="new-name" />
    <input [(ngModel)]="patient.nombre.apellido_primero" placeholder="Apellido primero" name="apellido1" unaPalabra autocomplete="new-name" />
    <input [(ngModel)]="patient.nombre.apellido_segundo" placeholder="Apellido segundo" name="apellido2" unaPalabra autocomplete="new-name" />
    <input [(ngModel)]="patient.nombre.casada" placeholder="Apellido casada" name="casada" *ngIf="patient.sexo === 'F'" autocomplete="new-name" />
  </fieldset>

  <!-- Sexo y Fecha -->
 <fieldset>
  <legend>Informaci√≥n b√°sica</legend>

  <label for="sexo">Sexo</label>
  <select [(ngModel)]="patient.sexo" name="sexo">
    <option value="">Seleccione sexo</option>
    <option value="M">Masculino</option>
    <option value="F">Femenino</option>
  </select>

  <label for="fechaNacimiento">Fecha de nacimiento</label>
  <input
    type="date"
    [(ngModel)]="patient.fecha_nacimiento"
    name="fechaNacimiento"
    (change)="calcularEdadDesdeFecha()"
  />

  <div style="margin-top: 1rem;">
    <p><strong>O calcula la fecha con la edad:</strong></p>

    <div style="display: flex; gap: 0.5rem;">
      <input
        type="number"
        [(ngModel)]="edadAnios"
        placeholder="A√±os"
        (input)="calcularFechaDesdeEdad()"
        min="0"
        style="width: 80px;"
      />
      <input
        type="number"
        [(ngModel)]="edadMeses"
        placeholder="Meses"
        (input)="calcularFechaDesdeEdad()"
        min="0"
        max="11"
        style="width: 80px;"
      />
      <input
        type="number"
        [(ngModel)]="edadDias"
        placeholder="D√≠as"
        (input)="calcularFechaDesdeEdad()"
        min="0"
        max="30"
        style="width: 80px;"
      />
    </div>
  </div>
</fieldset>
  <!-- Contacto -->
  <fieldset>
  <legend>Contacto</legend>

  <div *ngFor="let c of patient.contacto; let i = index">
    <label [for]="'contacto-' + i">{{ c.clave | titlecase }}</label>

    <!-- Si la clave es "telefono", aplica la directiva -->
    <input
      *ngIf="esTelefono(c.clave); else normalInput"
      type="text"
      [(ngModel)]="patient.contacto[i].valor"
      [name]="'contacto-' + i"
      [id]="'contacto-' + i"
      placeholder="Ingresa {{ c.clave }}"
      unaPalabra
      autocomplete="new-tel"
    />

    <!-- Si no, input sin directiva -->
    <ng-template #normalInput>
      <input
        type="text"
        [(ngModel)]="patient.contacto[i].valor"
        [name]="'contacto-' + i"
        [id]="'contacto-' + i"
        placeholder="Ingresa {{ c.clave }}"
      />
    </ng-template>
  </div>
</fieldset>
  <!-- Referencias -->
  <fieldset>
    <legend>Referencias</legend>
    <div *ngFor="let r of patient.referencias; let i = index">
      <input [(ngModel)]="r.nombre" placeholder="Nombre" name="referenciaNombre{{i}}" />
      <input [(ngModel)]="r.parentesco" placeholder="Parentesco" name="referenciaParentesco{{i}}" />
      <input [(ngModel)]="r.telefono" placeholder="Tel√©fono" name="referenciaTelefono{{i}}" />
    </div>
    <button (click)="patient.referencias.push({ nombre: '', telefono: '', parentesco: '' })">‚ûï A√±adir referencia</button>
  </fieldset>

  <!-- Datos Extra -->
  <fieldset>
    <legend>Datos extra</legend>
    <div *ngFor="let extra of patient.datos_extra; let i = index">
      <label [for]="'extra-' + i"  >{{ extra.tipo | titlecase }}</label>
      <input
        type="text"
        [(ngModel)]="patient.datos_extra[i].valor"
        [name]="'extra-' + i"
        [id]="'extra-' + i"
        placeholder="Ingresa {{ extra.valor }}"
        />
    </div>
    <button (click)="patient.datos_extra.push({ tipo: '', valor: '' })">‚ûï A√±adir dato extra</button>
  </fieldset>

  <!-- Estado -->
 <fieldset>
  <legend>Estado</legend>
  <select [(ngModel)]="patient.estado" name="estado">
    <option value="V">Vivo</option>
    <option value="M">Muerto</option>
  </select>
</fieldset>

  <!-- Metadatos -->
 <fieldset>
  <legend>Historial de registros</legend>
  <ul>
    <li *ngFor="let meta of patient.metadatos">
      {{ meta.usuario }} ‚Äî {{ meta.registro | date:'short' }}
    </li>
  </ul>
</fieldset>
  <!-- Botones -->
  <div class="botones">
    <button (click)="guardar()">üíæ Guardar</button>
    <button (click)="volver()">‚Ü©Ô∏è Cancelar</button>
  </div>
</div>
