<!-- ============================================================ -->
<!-- FORMULARIO DE PACIENTE - ESTRUCTURA PRINCIPAL -->
<!-- ============================================================ -->

<!-- SECCI√ìN 1: ENCABEZADO Y CONTROLES SUPERIORES -->
<!-- ============================================================ -->

<!-- Header -->
<h2 class="text-center text-white">
  {{ enEdicion() ? "Editar Paciente" : "Nuevo Paciente" }}
</h2>

<!-- Botones de acci√≥n superior -->
<div class="container">
  <div class="botones">
    <button type="button" (click)="volver()" [disabled]="isLoading()">
      <span [innerHTML]="cancelIcon"></span>
      Cancelar
    </button>
    <button type="button" (click)="irRenap()" [disabled]="isLoading()">
      <span [innerHTML]="findIcon"></span>
      Buscar en RENAP
    </button>
    <button
      type="submit"
      (click)="guardar()"
      [disabled]="!form.valid || isLoading()"
    >
      <span [innerHTML]="saveIcon"></span>
      {{ isLoading() ? "Guardando..." : "Guardar" }}
    </button>
  </div>
</div>

<!-- SECCI√ìN 2: ALERTAS Y ESTADOS DE CARGA -->
<!-- ============================================================ -->

<!-- Mostrar errores al usuario -->
@if (error()) {
<div class="alert alert-danger">
  {{ error() }}
</div>
}

<!-- Overlay de carga (pantalla oscura con spinner) -->
@if (isLoading()) {
<div class="loading-overlay">
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Cargando...</span>
  </div>
</div>
}

<!-- SECCI√ìN 3: FORMULARIO PRINCIPAL -->
<!-- ============================================================ -->

<form
  [formGroup]="form"
  class="formulario-moderno"
  (ngSubmit)="guardar()"
  [ngClass]="{ 'opacity-50': isLoading() }"
>
  <!-- Prevenir autocompletado del navegador -->
  <input type="text" name="fakeusernameremembered" style="display: none" />
  <input type="password" name="fakepasswordremembered" style="display: none" />

  <!-- ================ BLOQUE 1: EXPEDIENTE ================ -->
  <!-- Campo oculto para unidad -->
  <fieldset class="campo unidad d-none">
    <label for="unidad">Unidad</label>
    <input id="unidad" type="number" formControlName="unidad" />
  </fieldset>

  <!-- Opciones del expediente (crear, mantener, generar) -->
  <fieldset class="grupo identificadores">
    <legend>Opciones del Expediente</legend>

    <!-- Toggle para edici√≥n: opciones de expediente -->
    @if (enEdicion()) {
    <div class="toggle-buttons justify-content-center">
      <button
        [class.active]="accionExpediente() === 'mantener'"
        type="button"
        class="btn"
        (click)="accionExpediente.set('mantener')"
      >
        Mantener
      </button>
      <button
        [class.active]="accionExpediente() === 'generar'"
        type="button"
        class="btn"
        (click)="accionExpediente.set('generar')"
      >
        Generar
      </button>
      <button
        [class.active]="accionExpediente() === 'sobrescribir'"
        type="button"
        class="btn"
        (click)="accionExpediente.set('sobrescribir')"
      >
        Sobrescribir
      </button>
    </div>
    }

    <!-- Toggle para creaci√≥n: con o sin expediente -->
    @if (!enEdicion()) {
    <div class="toggle-buttons justify-content-center">
      <button
        [class.active]="!crearExpediente()"
        type="button"
        class="btn"
        (click)="crearExpediente.set(false)"
      >
        Sin Expediente
      </button>
      <button
        [class.active]="crearExpediente()"
        type="button"
        class="btn"
        (click)="crearExpediente.set(true)"
      >
        Con Expediente
      </button>
    </div>
    }

    <!-- -------- IDENTIFICADORES -------- -->
    <legend>Identificadores</legend>

    <!-- CUI (C√©dula √önica de Identificaci√≥n) -->
    <label for="cui">CUI</label>
    <input
      id="cui"
      type="text"
      formControlName="cui"
      placeholder="1234 56789 9999"
      mask="0000 00000 0000"
      (paste)="onPasteCUI($event)"
    />
    @if (form.get('cui')?.errors?.['validarDPI']){
    <div class="error">
      El CUI debe tener exactamente 13 d√≠gitos. Te faltan
      {{ form.get('cui')?.errors?.['validarDPI'].faltantes }} d√≠gito(s).
    </div>
    }

    <!-- Expediente (solo visible en edici√≥n con valor existente) -->
    @if (enEdicion() && form.get('expediente')?.value) {
    <label for="expediente">Expediente</label>
    <input
      id="expediente"
      type="text"
      formControlName="expediente"
      placeholder="N√∫mero de expediente"
      disable
      autocomplete="off"
    />
    }

    <!-- Pasaporte (solo si no es guatemalteco) -->
    @if (form.get('datos_extra.demograficos.nacionalidad')?.value !== 'GTM') {
    <label for="pasaporte">Pasaporte</label>
    <input
      id="pasaporte"
      type="text"
      formControlName="pasaporte"
      placeholder="Ingresa el pasaporte"
      autocomplete="off"
    />
    }

    <!-- Otra identificaci√≥n (solo si no tiene CUI) -->
    @if (!form.get('cui')?.value) {
    <label for="otro">Otra Identificaci√≥n</label>
    <input
      id="otro"
      type="text"
      formControlName="otro"
      placeholder="Constancia de Nacimiento"
      autocomplete="off"
    />
    }

    <!-- -------- ESTADO -------- -->
    <legend>Estado</legend>
    <select formControlName="estado" name="estado">
      <option value="V">Vivo</option>
      <option value="F">Muerto</option>
    </select>

    <!-- -------- BIOM√âTRICOS -------- -->
    <legend>Biom√©tricos</legend>
    <div class="biometricos">
      <div class="biometricos-contenedor">
        <div class="biometrico-foto">
          <h6 class="biometrico-label">Foto</h6>
        </div>
        <div class="biometrico-huella">
          <h6 class="biometrico-label">Huella</h6>
        </div>
      </div>
    </div>
  </fieldset>

  <!-- ================ BLOQUE 2: NOMBRES ================ -->
  <fieldset class="grupo nombres" formGroupName="nombre">
    <legend>Nombre</legend>

    <label for="primer_nombre">Primer Nombre</label>
    <input
      id="primer_nombre"
      formControlName="primer_nombre"
      placeholder="Primer nombre"
      unaPalabra
      autocomplete="off"
    />

    <label for="segundo_nombre">Segundo Nombre</label>
    <input
      id="segundo_nombre"
      formControlName="segundo_nombre"
      placeholder="Segundo nombre"
      unaPalabra
      autocomplete="off"
    />

    <label for="otro_nombre">Otro Nombre</label>
    <input
      id="otro_nombre"
      formControlName="otro_nombre"
      placeholder="Otro nombre"
      autocomplete="off"
    />

    <label for="primer_apellido">Primer Apellido</label>
    <input
      id="primer_apellido"
      formControlName="primer_apellido"
      placeholder="Apellido primero"
      unaPalabra
      autocomplete="off"
    />

    <label for="segundo_apellido">Segundo Apellido</label>
    <input
      id="segundo_apellido"
      formControlName="segundo_apellido"
      placeholder="Apellido segundo"
      unaPalabra
      autocomplete="off"
    />

    <!-- Apellido de casada (solo si es mujer) -->
    @if (form.get('sexo')?.value === 'F') {
    <label for="apellido_casada">Apellido de casada</label>
    <input
      id="apellido_casada"
      formControlName="apellido_casada"
      placeholder="Apellido casada"
      autocomplete="off"
    />
    }
  </fieldset>

  <!-- ================ BLOQUE 3: INFORMACI√ìN B√ÅSICA ================ -->
  <fieldset class="grupo info-basica">
    <legend>Informaci√≥n b√°sica</legend>

    <!-- Sexo -->
    <label for="sexo">Sexo</label>
    <select
      id="sexo"
      formControlName="sexo"
      name="sexo"
      [class.is-null]="!form.get('sexo')?.value"
    >
      <option value="">Seleccione sexo</option>
      <option value="M">Masculino</option>
      <option value="F">Femenino</option>
    </select>

    <!-- Fecha de nacimiento -->
    <label for="fecha_nacimiento">Fecha de nacimiento</label>
    <input
      id="fecha_nacimiento"
      type="date"
      formControlName="fecha_nacimiento"
      [ngClass]="form.get('fecha_nacimiento')?.value ? 'is-valid' : 'is-null'"
    />

    <!-- Edad (a√±os, meses, d√≠as) -->
    <legend>Edad</legend>
    <div class="edad" formGroupName="edad">
      <div class="edad-grupo fila-completa">
        <label for="anios">A√±os</label>
        <input
          id="anios"
          type="number"
          formControlName="anios"
          placeholder="A√±os"
          min="0"
          [ngClass]="
            form.get('fecha_nacimiento')?.value ? 'is-valid' : 'is-null'
          "
        />
      </div>

      <div class="edad-fila">
        <div class="edad-grupo">
          <label for="meses">Meses</label>
          <input
            id="meses"
            type="number"
            formControlName="meses"
            placeholder="Meses"
            min="0"
            max="11"
            [ngClass]="
              form.get('fecha_nacimiento')?.value ? 'is-valid' : 'is-null'
            "
          />
        </div>

        <div class="edad-grupo">
          <label for="dias">D√≠as</label>
          <input
            id="dias"
            type="number"
            formControlName="dias"
            placeholder="D√≠as"
            min="0"
            max="30"
            [ngClass]="
              form.get('fecha_nacimiento')?.value ? 'is-valid' : 'is-null'
            "
          />
        </div>
      </div>
    </div>

    <!-- -------- LUGAR DE NACIMIENTO -------- -->
    <fieldset class="grupo lugar-nacimiento">
      <legend>Lugar de Nacimiento</legend>

      <!-- CASO 1: Con CUI + Guatemalteco -->
      @if ( form.get('cui')?.value &&
      form.get('datos_extra.nacionalidad')?.value === 'GTM' ) {
      <div class="input-50" formGroupName="datos_extra">
        <div>
          <label for="departamento_nacimiento">Departamento</label>
          <select
            id="departamento_nacimiento"
            formControlName="departamento_nacimiento"
            name="departamento_nacimiento"
            [disabled]="true"
            [class.is-null]="
              !form.get('datos_extra.departamento_nacimiento')?.value
            "
          >
            <option value="">Seleccione departamento</option>
            <option *ngFor="let dep of enums.departamentos" [value]="dep.value">
              {{ dep.label }}
            </option>
          </select>
        </div>

        <div>
          <label for="lugar_nacimiento_1">Municipio</label>
          <select
            id="lugar_nacimiento_1"
            formControlName="lugar_nacimiento"
            name="lugar_nacimiento"
            [disabled]="true"
            [class.is-null]="!form.get('datos_extra.lugar_nacimiento')?.value"
          >
            <option value="">Seleccione municipio</option>
            <option
              *ngFor="let mun of municipios_nacimiento()"
              [value]="mun.municipio"
            >
              {{ mun.municipio }}
            </option>
          </select>
        </div>
      </div>
      }

      <!-- CASO 2: Sin CUI + Guatemalteco -->
      @if ( !form.get('cui')?.value &&
      form.get('datos_extra.nacionalidad')?.value === 'GTM' ) {
      <div class="input-50" formGroupName="datos_extra">
        <div>
          <label for="departamento_nacimiento_2">Departamento</label>
          <select
            id="departamento_nacimiento_2"
            formControlName="departamento_nacimiento"
            name="departamento_nacimiento"
            (change)="listarMunicipiosNacimiento()"
            [class.is-null]="
              !form.get('datos_extra.departamento_nacimiento')?.value
            "
          >
            <option value="">Seleccione departamento</option>
            <option *ngFor="let dep of enums.departamentos" [value]="dep.value">
              {{ dep.label }}
            </option>
          </select>
        </div>

        <div>
          <label for="lugar_nacimiento_2">Municipio</label>
          <select
            id="lugar_nacimiento_2"
            formControlName="lugar_nacimiento"
            name="lugar_nacimiento"
            [class.is-null]="!form.get('datos_extra.lugar_nacimiento')?.value"
          >
            <option value="">Seleccione municipio</option>
            <option
              *ngFor="let mun of municipios_nacimiento()"
              [value]="mun.municipio"
            >
              {{ mun.municipio }}
            </option>
          </select>
        </div>
      </div>
      }

      <!-- CASO 3: Extranjero -->
      @if (form.get('datos_extra.nacionalidad')?.value !== 'GTM') {
      <div formGroupName="datos_extra">
        <div>
          <label for="lugar_nacimiento_extranjero">Lugar de Nacimiento</label>
          <input
            id="lugar_nacimiento_extranjero"
            type="text"
            formControlName="lugar_nacimiento"
            name="lugar_nacimiento"
            placeholder="Pa√≠s/Lugar de nacimiento"
            [class.is-null]="!form.get('datos_extra.lugar_nacimiento')?.value"
          />
        </div>
      </div>
      }
    </fieldset>

    <!-- ================ BLOQUE 4: CONTACTO ================ -->
    <fieldset class="grupo contacto" formGroupName="contacto">
      <legend>Contacto</legend>

      <!-- Tel√©fonos -->
      <label for="telefono">Tel√©fono A</label>
      <input
        id="telefono"
        type="tel"
        formControlName="telefono"
        placeholder="Tel√©fono A"
        autocomplete="off"
      />

      <label for="telefono2">Tel√©fono B</label>
      <input
        id="telefono2"
        type="tel"
        formControlName="telefono2"
        placeholder="Tel√©fono B"
        autocomplete="off"
      />

      <label for="telefono3">Tel√©fono C</label>
      <input
        id="telefono3"
        type="tel"
        formControlName="telefono3"
        placeholder="Tel√©fono C"
        autocomplete="off"
      />

      <!-- Ubicaci√≥n geogr√°fica -->
      <label for="departamento">Departamento</label>
      <select
        id="departamento"
        formControlName="departamento"
        name="departamento"
        (change)="listarMunicipiosDireccion()"
        [class.is-null]="!form.get('contacto.departamento')?.value"
      >
        <option value="">Seleccione departamento</option>
        <option *ngFor="let dep of enums.departamentos" [value]="dep.value">
          {{ dep.label }}
        </option>
      </select>

      <label for="municipio">Municipio</label>
      <select
        id="municipio"
        formControlName="municipio"
        name="municipio"
        [class.is-null]="!form.get('contacto.municipio')?.value"
      >
        <option value="">Seleccione municipio</option>
        <option *ngFor="let mun of municipios_direccion()" [value]="mun.codigo">
          {{ mun.vecindad }}
        </option>
      </select>

      <!-- Direcci√≥n -->
      <label for="localidad">Direcci√≥n domicilio</label>
      <input
        id="localidad"
        type="text"
        formControlName="localidad"
        placeholder="Direcci√≥n"
        autocomplete="off"
      />
    </fieldset>

    <!-- ================ BLOQUE 5: REFERENCIAS (PARIENTES) ================ -->
    <fieldset class="grupo referencias">
      <legend>Referencias</legend>
      <div formArrayName="referencias">
        <div
          *ngFor="let ref of referencias.controls; let i = index"
          [formGroupName]="i"
          class="referencia-item"
          [class.es-responsable]="ref.get('responsable')?.value"
        >
          <!-- Checkbox responsable -->
          <div class="checkbox-responsable">
            <label class="checkbox-label">
              <input
                type="checkbox"
                formControlName="responsable"
                (change)="marcarComoResponsable(i)"
              />
              @if (ref.get('responsable')?.value) {
              <span class="responsable-badge">‚òÖ Responsable</span>
              }
            </label>
          </div>

          <!-- Nombre -->
          <input
            type="text"
            formControlName="nombre"
            placeholder="Nombre de referencia"
            autocomplete="off"
          />

          <!-- Tel√©fono -->
          <input
            type="tel"
            formControlName="telefono"
            placeholder="Tel√©fono"
            autocomplete="off"
          />

          <!-- Parentesco -->
          <select formControlName="parentesco">
            <option value="">-- Seleccione --</option>
            <option *ngFor="let p of enums.parentescos" [value]="p.value">
              {{ p.label }}
            </option>
          </select>

          <!-- Botones de acci√≥n -->
          <div class="botones justify-content-between">
            <button
              class="btn-sm btn-danger"
              type="button"
              (click)="eliminarReferencia(i)"
              [disabled]="referencias.length === 1"
            >
              <span [innerHTML]="removeIcon"></span>
              Eliminar
            </button>
            <button
              class="btn-sm btn-primary"
              type="button"
              (click)="agregarReferencia()"
            >
              <span [innerHTML]="addIcon"></span>
              Agregar
            </button>
          </div>
        </div>
      </div>

      <!-- Informaci√≥n informativa -->
      <p class="info-text">
        <small>
          üí° Marca con ‚òÖ a la persona responsable. Solo una referencia puede ser
          responsable.
        </small>
      </p>
    </fieldset>

    <!-- ================ BLOQUE 6: DATOS EXTRA ESTRUCTURADO ================ -->
    <fieldset class="grupo datos-extra" formGroupName="datos_extra">
      <legend>Datos Extra</legend>

      <!-- Defunci√≥n y CUI Persona -->
      <div class="d-flex gap-3">
        <div style="flex: 1">
          <label for="defuncion">Defunci√≥n</label>
          <input
            id="defuncion"
            type="text"
            formControlName="defuncion"
            placeholder="Informaci√≥n de defunci√≥n"
          />
        </div>
        <div style="flex: 1">
          <label for="cuipersona">CUI Persona</label>
          <input
            id="cuipersona"
            type="text"
            formControlName="cuipersona"
            placeholder="CUI"
          />
        </div>
      </div>

      <!-- -------- DEMOGR√ÅFICOS -------- -->
      <fieldset formGroupName="demograficos" class="sub-fieldset">
        <legend>Informaci√≥n Demogr√°fica</legend>

        <!-- Nacionalidad -->
        <div>
          <label for="nacionalidad">Nacionalidad</label>
          <select
            id="nacionalidad"
            formControlName="nacionalidad"
            [ngClass]="
              form.get('datos_extra.demograficos.nacionalidad')?.value
                ? 'is-valid'
                : 'is-null'
            "
          >
            <option value="">Seleccione nacionalidad</option>
            <option *ngFor="let n of paisesIso()" [value]="n.codigo_iso3">
              {{ n.nombre }}
            </option>
          </select>
        </div>

        <!-- Estado Civil -->
        <div>
          <label for="estado_civil">Estado Civil</label>
          <select
            id="estado_civil"
            formControlName="estado_civil"
            [ngClass]="
              form.get('datos_extra.demograficos.estado_civil')?.value
                ? 'is-valid'
                : 'is-null'
            "
          >
            <option value="">Seleccione</option>
            <option *ngFor="let ec of enums.estadocivil" [value]="ec.value">
              {{ ec.label }}
            </option>
          </select>
        </div>

        <!-- Pueblo -->
        <div>
          <label for="pueblo">Pueblo</label>
          <select
            id="pueblo"
            formControlName="pueblo"
            [ngClass]="
              form.get('datos_extra.demograficos.pueblo')?.value
                ? 'is-valid'
                : 'is-null'
            "
          >
            <option value="">Seleccione</option>
            <option *ngFor="let p of enums.pueblos" [value]="p.value">
              {{ p.label }}
            </option>
          </select>
        </div>

        <!-- Idioma -->
        <div>
          <label for="idioma">Idioma</label>
          <select
            id="idioma"
            formControlName="idioma"
            [ngClass]="
              form.get('datos_extra.demograficos.idioma')?.value
                ? 'is-valid'
                : 'is-null'
            "
          >
            <option value="">Seleccione</option>
            <option *ngFor="let i of enums.idiomas" [value]="i.value">
              {{ i.label }}
            </option>
          </select>
        </div>

        <!-- Lugar de Nacimiento (para extranjeros) -->
        @if ( form.get('datos_extra.demograficos.nacionalidad')?.value !== 'GTM'
        ) {
        <div>
          <label for="lugar_nacimiento_demo">Lugar de Nacimiento</label>
          <input
            id="lugar_nacimiento_demo"
            type="text"
            formControlName="lugar_nacimiento"
            placeholder="Pa√≠s/Lugar"
          />
        </div>
        }

        <!-- Departamento Nacimiento (para guatemaltecos) -->
        @if (form.get('datos_extra.demograficos.nacionalidad')?.value === 'GTM')
        {
        <div>
          <label for="departamento_nacimiento">Departamento Nacimiento</label>
          <select
            id="departamento_nacimiento"
            formControlName="departamento_nacimiento"
            (change)="listarMunicipiosNacimiento()"
          >
            <option value="">Seleccione</option>
            <option *ngFor="let dep of enums.departamentos" [value]="dep.value">
              {{ dep.label }}
            </option>
          </select>
        </div>
        }

        <!-- Municipio Nacimiento (para guatemaltecos) -->
        @if (form.get('datos_extra.demograficos.nacionalidad')?.value === 'GTM')
        {
        <div>
          <label for="municipio_nacimiento">Municipio Nacimiento</label>
          <select
            id="municipio_nacimiento"
            formControlName="municipio_nacimiento"
          >
            <option value="">Seleccione</option>
            <option
              *ngFor="let mun of municipios_nacimiento()"
              [value]="mun.codigo"
            >
              {{ mun.municipio }}
            </option>
          </select>
        </div>
        }
      </fieldset>

      <!-- -------- SOCIOECON√ìMICOS -------- -->
      <fieldset formGroupName="socioeconomicos" class="sub-fieldset">
        <legend>Informaci√≥n Socioecon√≥mica</legend>

        <!-- Ocupaci√≥n -->
        <div>
          <label for="ocupacion">Ocupaci√≥n</label>
          <input
            id="ocupacion"
            type="text"
            formControlName="ocupacion"
            [ngClass]="
              form.get('datos_extra.socioeconomicos.ocupacion')?.value
                ? 'is-valid'
                : 'is-null'
            "
            placeholder="Ocupaci√≥n"
          />
        </div>

        <!-- Nivel Educativo -->
        <div>
          <label for="nivel_educativo">Nivel Educativo</label>
          <select
            id="nivel_educativo"
            formControlName="nivel_educativo"
            [ngClass]="
              form.get('datos_extra.socioeconomicos.nivel_educativo')?.value
                ? 'is-valid'
                : 'is-null'
            "
          >
            <option value="">Seleccione</option>
            <option *ngFor="let ne of enums.gradoacademico" [value]="ne.value">
              {{ ne.label }}
            </option>
          </select>
        </div>

        <!-- Toggles de S√≠/No -->
        <div class="d-flex gap-3">
          <!-- Estudiante P√∫blico -->
          <div class="toggle-group" style="flex: 1">
            <label>Estudiante P√∫blico</label>
            <div class="toggle-buttons">
              <button
                type="button"
                [class.active]="
                  form.get('datos_extra.socioeconomicos.estudiante_publico')
                    ?.value === 'SI'
                "
                (click)="
                  form
                    .get('datos_extra.socioeconomicos.estudiante_publico')
                    ?.setValue('SI')
                "
              >
                S√≠
              </button>
              <button
                type="button"
                [class.active]="
                  form.get('datos_extra.socioeconomicos.estudiante_publico')
                    ?.value === 'NO'
                "
                (click)="
                  form
                    .get('datos_extra.socioeconomicos.estudiante_publico')
                    ?.setValue('NO')
                "
              >
                No
              </button>
            </div>
          </div>

          <!-- Empleado P√∫blico -->
          <div class="toggle-group" style="flex: 1">
            <label>Empleado P√∫blico</label>
            <div class="toggle-buttons">
              <button
                type="button"
                [class.active]="
                  form.get('datos_extra.socioeconomicos.empleado_publico')
                    ?.value === 'SI'
                "
                (click)="
                  form
                    .get('datos_extra.socioeconomicos.empleado_publico')
                    ?.setValue('SI')
                "
              >
                S√≠
              </button>
              <button
                type="button"
                [class.active]="
                  form.get('datos_extra.socioeconomicos.empleado_publico')
                    ?.value === 'NO'
                "
                (click)="
                  form
                    .get('datos_extra.socioeconomicos.empleado_publico')
                    ?.setValue('NO')
                "
              >
                No
              </button>
            </div>
          </div>

          <!-- Discapacidad -->
          <div class="toggle-group" style="flex: 1">
            <label>Discapacidad</label>
            <div class="toggle-buttons">
              <button
                type="button"
                [class.active]="
                  form.get('datos_extra.socioeconomicos.discapacidad')
                    ?.value === 'SI'
                "
                (click)="
                  form
                    .get('datos_extra.socioeconomicos.discapacidad')
                    ?.setValue('SI')
                "
              >
                S√≠
              </button>
              <button
                type="button"
                [class.active]="
                  form.get('datos_extra.socioeconomicos.discapacidad')
                    ?.value === 'NO'
                "
                (click)="
                  form
                    .get('datos_extra.socioeconomicos.discapacidad')
                    ?.setValue('NO')
                "
              >
                No
              </button>
            </div>
          </div>
        </div>
      </fieldset>

      <!-- -------- NEONATALES (Solo para reci√©n nacidos) -------- -->
      @if (esRecienNacido()) {
      <fieldset formGroupName="neonatales" class="sub-fieldset">
        <legend>Datos de Nacimiento (Reci√©n Nacido)</legend>

        <!-- Peso de Nacimiento -->
        <div>
          <label for="peso_nacimiento">Peso Nacimiento (libras.onzas)</label>
          <input
            id="peso_nacimiento"
            type="text"
            formControlName="peso_nacimiento"
            placeholder="Ej: 3.08"
          />
        </div>

        <!-- Edad Gestacional -->
        <div>
          <label for="edad_gestacional">Edad Gestacional (semanas)</label>
          <input
            id="edad_gestacional"
            type="text"
            formControlName="edad_gestacional"
            soloNumero
            placeholder="Ej: 40"
          />
        </div>

        <!-- Tipo de Parto -->
        <div>
          <label for="parto">Tipo de Parto</label>
          <select id="parto" formControlName="parto">
            <option value="">Seleccione</option>
            <option value="P">Vaginal</option>
            <option value="C">Ces√°rea</option>
          </select>
        </div>

        <!-- N√∫mero de Gemelo -->
        <div>
          <label for="gemelo">N√∫mero de Gemelo</label>
          <input
            id="gemelo"
            type="text"
            formControlName="gemelo"
            soloNumero
            placeholder="Ej: 1"
          />
        </div>

        <!-- Expediente de la Madre -->
        <div>
          <label for="expediente_madre">Expediente de la Madre</label>
          <input
            id="expediente_madre"
            type="text"
            formControlName="expediente_madre"
            unaPalabra
            placeholder="Ej: 12345"
          />
        </div>
      </fieldset>
      }
    </fieldset>

    <!-- ================ BLOQUE 7: HISTORIAL DE REGISTROS ================ -->
    <!-- ================= HISTORIAL ================= -->
    <fieldset>
      <legend>Historial de registros</legend>

      @if (sortedMetadatos().length > 0) {
      <ul class="historial-grid">
        <li *ngFor="let meta of sortedMetadatos()">
          <strong>{{ meta.creado_por }}</strong
          ><br />
          <small>{{ meta.creado_en | date : "short" }}</small>
        </li>
      </ul>
      } @else {
      <p class="text-muted">Sin historial de registros</p>
      }
    </fieldset>
  </fieldset>
</form>
