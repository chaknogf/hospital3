<form [formGroup]="form" class="formulario-paciente" (ngSubmit)="guardar()">
  <!-- Anti-autocompletado -->
  <input type="text" name="fakeusernameremembered" style="display: none;" />
  <input type="password" name="fakepasswordremembered" style="display: none;" />

  <h2>{{ enEdicion ? 'Editar Paciente' : 'Nuevo Paciente' }}</h2>

  <!-- Unidad -->
  <div class="campo unidad">
    <label for="unidad">Unidad</label>
    <input
      id="unidad"
      type="number"
      formControlName="unidad"
      style="width: 35px; height: 10px; font-size: 12px;"
    />
  </div>

  <!-- Identificadores -->
  <fieldset class="grupo identificadores" formGroupName="identificadores">
    <legend>Identificadores</legend>

    <label for="cui">CUI</label>
    <input
      id="cui"
      type="number"
      formControlName="cui"
      placeholder="Ingresa el n√∫mero de CUI"
      validarDPI
      unaPalabra
      maxlength="13"
      required

    />
    <div *ngIf="form.get('identificadores.cui')?.value?.length !== 13 && form.get('identificadores.cui')?.touched" class="input-error-msg">
      El CUI debe tener exactamente 13 d√≠gitos.
    </div>

    <label *ngIf="enEdicion == true" for="expediente" >Expediente</label>
    <div class="input-buton" *ngIf="form.get('identificadores.expediente')?.value === ''">
      <input
        id="expediente"
        type="text"
        formControlName="expediente"
        placeholder="Ingresa el n√∫mero de expediente"
        *ngIf="enEdicion == true"
        required
        unaPalabra
      />
      <!-- <button type="button" (click)="generarExpediente()" class="btn-input">Generar Expediente</button> -->
    </div>

    <label for="pasaporte" *ngIf="form.get('datos_extra.r0.nacionalidad')?.value !== 'GTM'">Pasaporte</label>
    <input
      id="pasaporte"
      type="text"
      formControlName="pasaporte"
      placeholder="Ingresa el pasaporte"
      *ngIf="form.get('datos_extra.r0.nacionalidad')?.value !== 'GTM'"
    />
  </fieldset>

  <!-- Nombre -->
  <fieldset class="grupo nombres" formGroupName="nombre">
    <legend>Nombre</legend>
    <input formControlName="primer" placeholder="Primer nombre" name="nombre1" unaPalabra autocomplete="new-name" />
    <input formControlName="segundo" placeholder="Segundo nombre" name="nombre2" unaPalabra autocomplete="new-name" />
    <input formControlName="otro" placeholder="Otro nombre" name="nombre3" *ngIf="form.get('nombre.segundo')?.value" autocomplete="new-name" />
    <input formControlName="apellido_primero" placeholder="Apellido primero" name="apellido1" unaPalabra autocomplete="new-name" />
    <input formControlName="apellido_segundo" placeholder="Apellido segundo" name="apellido2" unaPalabra autocomplete="new-name" />
    <input formControlName="casada" placeholder="Apellido casada" name="casada" *ngIf="form.get('sexo')?.value === 'F'" autocomplete="new-name" />
  </fieldset>

  <!-- Informaci√≥n B√°sica -->
  <fieldset class="grupo info-basica">
    <legend>Informaci√≥n b√°sica</legend>

    <label for="sexo">Sexo</label>
    <select formControlName="sexo" name="sexo">
      <option value="">Seleccione sexo</option>
      <option value="M">Masculino</option>
      <option value="F">Femenino</option>
    </select>

    <label for="fechaNacimiento">Fecha de nacimiento</label>
    <input type="date" formControlName="fecha_nacimiento" name="fechaNacimiento" />

    <div class="edad-manual" formGroupName="edad">
      <p><strong>O calcula la fecha con la edad:</strong></p>
      <div class="edad-inputs">
        <input type="number" formControlName="anios" placeholder="A√±os" min="0" (input)="calcularFechaDesdeEdad()" />
        <input type="number" formControlName="meses" placeholder="Meses" min="0" max="11" (input)="calcularFechaDesdeEdad()" />
        <input type="number" formControlName="dias" placeholder="D√≠as" min="0" max="30" (input)="calcularFechaDesdeEdad()" />
      </div>
    </div>
  </fieldset>

  <!-- Contacto -->
  <fieldset class="grupo contacto" formGroupName="contacto">
    <legend>Contacto</legend>
    <label for="telefono_a">Tel√©fono A</label>
    <input type="number" formControlName="telefono" placeholder="Tel√©fono A" name="telefono_a" />
    <label for="telefono_b">Tel√©fono B</label>
    <input type="number" formControlName="telefono2" placeholder="Tel√©fono B" name="telefono_b" />
    <label for="telefono_c">Tel√©fono C</label>
    <input type="number" formControlName="telefono3" placeholder="Tel√©fono C" name="telefono_c" />
    <label for="municipio">Municipio</label>
    <input type="text" formControlName="municipio" placeholder="Municipio" name="municipio" />
    <label for="direccion">Direcci√≥n domicilio</label>
    <input type="text" formControlName="direccion" placeholder="Direcci√≥n" name="direccion" />
  </fieldset>

  <!-- Referencias -->
  <fieldset class="grupo referencias" >
    <legend>Referencias</legend>
    <div formGroupName="referencias">
  <div *ngFor="let key of referenciasKeys(); let i = index" [formGroupName]="key">
    <input formControlName="nombre" placeholder="Nombre de referencia">
    <input formControlName="telefono" placeholder="Tel√©fono">
    <input formControlName="parentesco" placeholder="Parentesco">
    <button type="button" (click)="eliminarReferencia(key)">Eliminar</button>
  </div>
</div>

<button type="button" (click)="agregarReferencia()">Agregar referencia</button>
  </fieldset>

  <fieldset class="grupo datos-extra">
  <legend>Datos extra</legend>

  <div formGroupName="datos_extra">
    <div formGroupName="r0">
      <label for="nacionalidad">Nacionalidad</label>
      <input type="text" id="nacionalidad" formControlName="nacionalidad" />
    </div>

    <div formGroupName="r1">
      <label for="estado_civil">Estado civil</label>
      <input type="text" id="estado_civil" formControlName="estado_civil" />
    </div>

    <div formGroupName="r2">
      <label for="pueblo">Pueblo</label>
      <input type="text" id="pueblo" formControlName="pueblo" />
    </div>

    <!-- Idioma est√° directamente en datos_extra -->
    <div>
      <label for="idioma">Idioma</label>
      <input type="text" id="idioma" formControlName="idioma" />
    </div>
  </div>

  <!-- r3 a r7 est√°n directamente en this.form -->
  <div formGroupName="r3">
    <label for="ocupacion">Ocupaci√≥n</label>
    <input type="text" id="ocupacion" formControlName="ocupacion" />
  </div>

  <div formGroupName="r4">
    <label for="nivel_educativo">Nivel educativo</label>
    <input type="text" id="nivel_educativo" formControlName="nivel_educativo" />
  </div>

  <div formGroupName="r5">
    <label for="peso_nacimiento">Peso nacimiento</label>
    <input type="number" id="peso_nacimiento" formControlName="peso_nacimiento" />
  </div>

  <div formGroupName="r6">
    <label for="edad_gestacional">Edad gestacional</label>
    <input type="number" id="edad_gestacional" formControlName="edad_gestacional" />
  </div>

  <div formGroupName="r7">
    <label for="parto">Parto</label>
    <input type="text" id="parto" formControlName="parto" />
  </div>
</fieldset>

  <!-- Estado -->
  <fieldset class="grupo estado">
    <legend>Estado</legend>
    <select formControlName="estado" name="estado">
      <option value="V">Vivo</option>
      <option value="M">Muerto</option>
    </select>
  </fieldset>

  <!-- Metadatos -->
  <fieldset class="grupo metadatos">
    <legend>Historial de registros</legend>
    <ul class="historial-grid">
      <li *ngFor="let meta of sortedMetadatos; let i = index">
        {{ meta.usuario }} ‚Äî {{ meta.registro | date:'short' }}
      </li>
    </ul>
  </fieldset>

  <!-- Botones -->
  <div class="botones">
    <button type="submit">üíæ Guardar</button>
    <button type="button" (click)="volver()">‚Ü©Ô∏è Cancelar</button>
  </div>
</form>
