<!-- ============================================================ -->
<!-- FORMULARIO DE PACIENTE - ESTRUCTURA PRINCIPAL -->
<!-- ============================================================ -->

<!-- SECCI√ìN 1: ENCABEZADO Y CONTROLES SUPERIORES -->
<!-- ============================================================ -->

<!-- Header -->
<h2 class="text-center text-white">
  {{ enEdicion() ? "Editar Paciente" : "Nuevo Paciente" }}
</h2>

<!-- Botones de acci√≥n superior -->
<div class="container">
  <div class="botones">
    <button type="button" (click)="volver()" [disabled]="isLoading()">
      <span [innerHTML]="cancelIcon"></span>
      Cancelar
    </button>
    <button type="button" (click)="irRenap()" [disabled]="isLoading()">
      <span [innerHTML]="findIcon"></span>
      Buscar en RENAP
    </button>
    <button
      type="submit"
      (click)="guardar()"
      [disabled]="!form.valid || isLoading()"
    >
      <span [innerHTML]="saveIcon"></span>
      {{ isLoading() ? "Guardando..." : "Guardar" }}
    </button>
  </div>
</div>

<!-- SECCI√ìN 2: ALERTAS Y ESTADOS DE CARGA -->
<!-- ============================================================ -->

<!-- Mostrar errores al usuario -->
@if (error()) {
<div class="alert alert-danger">
  {{ error() }}
</div>
}

<!-- Overlay de carga (pantalla oscura con spinner) -->
@if (isLoading()) {
<div class="loading-overlay">
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Cargando...</span>
  </div>
</div>
}

<!-- SECCI√ìN 3: FORMULARIO PRINCIPAL -->
<!-- ============================================================ -->

<form
  [formGroup]="form"
  class="formulario-moderno"
  (ngSubmit)="guardar()"
  [ngClass]="{ 'opacity-50': isLoading() }"
>
  <!-- Prevenir autocompletado del navegador -->
  <input type="text" name="fakeusernameremembered" style="display: none" />
  <input type="password" name="fakepasswordremembered" style="display: none" />

  <!-- ================ BLOQUE 1: EXPEDIENTE ================ -->

  <!-- Opciones del expediente (crear, mantener, generar) -->
  <fieldset class="grupo identificadores">
    <legend>Opciones del Expediente</legend>

    <!-- Toggle para edici√≥n: opciones de expediente -->
    @if (enEdicion()) {
    <div class="toggle-buttons justify-content-center">
      <button
        [class.active]="accionExpediente() === 'mantener'"
        type="button"
        class="btn"
        (click)="accionExpediente.set('mantener')"
      >
        Mantener
      </button>
      <button
        [class.active]="accionExpediente() === 'generar'"
        type="button"
        class="btn"
        (click)="accionExpediente.set('generar')"
      >
        Generar
      </button>
      <button
        [class.active]="accionExpediente() === 'sobrescribir'"
        type="button"
        class="btn"
        (click)="accionExpediente.set('sobrescribir')"
      >
        Sobrescribir
      </button>
    </div>
    }

    <!-- Toggle para creaci√≥n: con o sin expediente -->
    @if (!enEdicion()) {
    <div class="toggle-buttons justify-content-center">
      <button
        [class.active]="!crearExpediente()"
        type="button"
        class="btn"
        (click)="crearExpediente.set(false)"
      >
        Sin Expediente
      </button>
      <button
        [class.active]="crearExpediente()"
        type="button"
        class="btn"
        (click)="crearExpediente.set(true)"
      >
        Con Expediente
      </button>
    </div>
    }

    <!-- -------- IDENTIFICADORES -------- -->
    <legend>Identificadores</legend>

    <!-- CUI (C√©dula √önica de Identificaci√≥n) -->
    <label for="cui">CUI</label>
    <input
      id="cui"
      type="text"
      formControlName="cui"
      placeholder="1234 56789 9999"
      mask="0000 00000 0000"
      (paste)="onPasteCUI($event)"
    />
    @if (form.get('cui')?.errors?.['validarDPI']){
    <div class="error">
      El CUI debe tener exactamente 13 d√≠gitos. Te faltan
      {{ form.get('cui')?.errors?.['validarDPI'].faltantes }} d√≠gito(s).
    </div>
    }

    <!-- Expediente (solo visible en edici√≥n con valor existente) -->
    @if (enEdicion() && form.get('expediente')?.value) {
    <label for="expediente">Expediente</label>
    <input
      id="expediente"
      type="text"
      formControlName="expediente"
      placeholder="N√∫mero de expediente"
      disable
      autocomplete="off"
    />
    }

    <!-- Pasaporte (solo si no es guatemalteco) -->
    @if (form.get('datos_extra.demograficos.nacionalidad')?.value !== 'GTM') {
    <label for="pasaporte">Pasaporte</label>
    <input
      id="pasaporte"
      type="text"
      formControlName="pasaporte"
      placeholder="Ingresa el pasaporte"
      autocomplete="off"
    />
    }

    <!-- Otra identificaci√≥n (solo si no tiene CUI) -->
    @if (!form.get('cui')?.value) {
    <div style="flex: 1">
      <label for="personaid">Otra Identificaci√≥n</label>
      <input
        id="personaid"
        type="text"
        formControlName="datos_extra.personaid"
        placeholder="otra forma de identificaci√≥n"
        autocomplete="off"
      />
    </div>

    }

    <!-- -------- BIOM√âTRICOS -------- -->
    <legend>Biom√©tricos</legend>
    <div class="biometricos">
      <div class="biometricos-contenedor d-flex justify-content-around">
        <div class="biometrico-foto">
          <span [innerHTML]="faceidicon"></span>
          <h6 class="biometrico-label">Foto</h6>
        </div>
        <div class="biometrico-huella">
          <span [innerHTML]="touchicon"></span>
          <h6 class="biometrico-label">Huella</h6>
        </div>
      </div>
    </div>
  </fieldset>

  <!-- ================ BLOQUE 2: NOMBRES ================ -->
  <fieldset class="grupo nombres" formGroupName="nombre">
    <legend>Nombre</legend>

    <label for="primer_nombre">Primer Nombre</label>
    <input
      id="primer_nombre"
      formControlName="primer_nombre"
      placeholder="Primer nombre"
      unaPalabra
      autocomplete="off"
    />

    <label for="segundo_nombre">Segundo Nombre</label>
    <input
      id="segundo_nombre"
      formControlName="segundo_nombre"
      placeholder="Segundo nombre"
      unaPalabra
      autocomplete="off"
    />

    <label for="otro_nombre">Otro Nombre</label>
    <input
      id="otro_nombre"
      formControlName="otro_nombre"
      placeholder="Otro nombre"
      autocomplete="off"
    />

    <label for="primer_apellido">Primer Apellido</label>
    <input
      id="primer_apellido"
      formControlName="primer_apellido"
      placeholder="Apellido primero"
      unaPalabra
      autocomplete="off"
    />

    <label for="segundo_apellido">Segundo Apellido</label>
    <input
      id="segundo_apellido"
      formControlName="segundo_apellido"
      placeholder="Apellido segundo"
      unaPalabra
      autocomplete="off"
    />

    <!-- Apellido de casada (solo si es mujer) -->
    @if (form.get('sexo')?.value === 'F') {
    <label for="apellido_casada">Apellido de casada</label>
    <input
      id="apellido_casada"
      formControlName="apellido_casada"
      placeholder="Apellido casada"
      autocomplete="off"
    />
    }
  </fieldset>

  <!-- ================ BLOQUE 3: INFORMACI√ìN B√ÅSICA ================ -->
  <fieldset class="grupo info-basica">
    <legend>Informaci√≥n b√°sica</legend>
    <!-- -------- ESTADO -------- -->
    <select formControlName="estado" name="estado">
      <option value="V">Vivo</option>
      <option value="F">Muerto</option>
    </select>
    @if (form.get('estado')?.value === 'F') {
    <div style="flex: 1" formGroupName="datos_extra">
      <label for="defuncion">Defunci√≥n</label>
      <input id="defuncion" type="datetime-local" formControlName="defuncion" />
    </div>
    }
    <!-- Sexo -->
    <label for="sexo">Sexo</label>
    <select
      id="sexo"
      formControlName="sexo"
      name="sexo"
      [class.is-null]="!form.get('sexo')?.value"
    >
      <option value="">Seleccione sexo</option>
      <option value="M">Masculino</option>
      <option value="F">Femenino</option>
    </select>

    <!-- Fecha de nacimiento -->
    <label for="fecha_nacimiento">Fecha de nacimiento</label>
    <input
      id="fecha_nacimiento"
      type="date"
      formControlName="fecha_nacimiento"
      [ngClass]="form.get('fecha_nacimiento')?.value ? 'is-valid' : 'is-null'"
    />

    <!-- Edad (a√±os, meses, d√≠as) -->
    <legend>Edad</legend>
    <div class="edad" formGroupName="edad">
      <div class="edad-grupo fila-completa">
        <label for="anios">A√±os</label>
        <input
          id="anios"
          type="number"
          formControlName="anios"
          placeholder="A√±os"
          min="0"
          [ngClass]="
            form.get('fecha_nacimiento')?.value ? 'is-valid' : 'is-null'
          "
        />
      </div>

      <div class="edad-fila">
        <div class="edad-grupo">
          <label for="meses">Meses</label>
          <input
            id="meses"
            type="number"
            formControlName="meses"
            placeholder="Meses"
            min="0"
            max="11"
            [ngClass]="
              form.get('fecha_nacimiento')?.value ? 'is-valid' : 'is-null'
            "
          />
        </div>

        <div class="edad-grupo">
          <label for="dias">D√≠as</label>
          <input
            id="dias"
            type="number"
            formControlName="dias"
            placeholder="D√≠as"
            min="0"
            max="30"
            [ngClass]="
              form.get('fecha_nacimiento')?.value ? 'is-valid' : 'is-null'
            "
          />
        </div>
      </div>
    </div>
  </fieldset>

  <!-- ================ BLOQUE 4: CONTACTO ================ -->
  <fieldset class="grupo contacto" formGroupName="contacto">
    <legend>Contacto</legend>

    <!-- Tel√©fonos -->
    <label for="telefonos">Tel√©fonos</label>
    <input
      id="telefonos"
      type="tel"
      formControlName="telefonos"
      placeholder="Tel√©fono: 00009999 00011111 00022222"
      autocomplete="off"
    />

    <!-- Email -->
    <label for="email">Correo electr√≥nico</label>
    <input
      type="email"
      id="email"
      formControlName="email"
      placeholder="Correo electr√≥nico"
      autocomplete="off"
    />

    <!-- Ubicaci√≥n geogr√°fica -->
    <label for="departamento">Departamento</label>

    <select
      id="departamento"
      formControlName="departamento"
      name="departamento"
    >
      <option value="">Seleccione departamento</option>
      <option *ngFor="let dep of enums.departamentos" [value]="dep.value">
        {{ dep.label }}
      </option>
    </select>

    <label for="municipio">Municipio</label>
    <select id="municipio" formControlName="municipio" name="municipio">
      <option value="">Seleccione municipio</option>
      <option *ngFor="let mun of municipios_direccion()" [value]="mun.codigo">
        {{ mun.vecindad }}
      </option>
    </select>

    <!-- Direcci√≥n -->
    <label for="domicilio">Direcci√≥n domicilio</label>
    <input
      id="domicilio"
      type="text"
      formControlName="domicilio"
      placeholder="Direcci√≥n de Domicilio"
      autocomplete="off"
    />
  </fieldset>

  <!-- ================ BLOQUE 5: REFERENCIAS (PARIENTES) ================ -->
  <fieldset class="grupo referencias">
    <legend>Referencias</legend>
    <div formArrayName="referencias">
      <div
        *ngFor="let ref of referencias.controls; let i = index"
        [formGroupName]="i"
        class="referencia-item"
        [class.es-responsable]="ref.get('responsable')?.value"
      >
        <!-- Checkbox responsable -->
        <div class="checkbox-responsable">
          <label class="checkbox-label">
            <input
              type="checkbox"
              formControlName="responsable"
              (change)="marcarComoResponsable(i)"
            />
            @if (ref.get('responsable')?.value) {
            <span class="responsable-badge">‚òÖ Responsable</span>
            }
          </label>
        </div>

        <!-- Nombre -->
        <label for="nombre">Nombre</label>
        <input
          type="text"
          formControlName="nombre"
          placeholder="Nombre de referencia"
          autocomplete="off"
        />

        <!-- Tel√©fono -->
        <label for="telefono">Tel√©fono</label>
        <input
          type="tel"
          formControlName="telefono"
          placeholder="Tel√©fono"
          autocomplete="off"
        />

        <!-- Parentesco -->
        <label for="parentesco">Parentesco</label>
        <select formControlName="parentesco">
          <option value="">-- Seleccione --</option>
          <option *ngFor="let p of enums.parentescos" [value]="p.value">
            {{ p.label }}
          </option>
        </select>

        <!-- idpersona -->
        <label for="idpersona">identificaci√≥n</label>
        <input
          type="text"
          formControlName="idpersona"
          placeholder="identificaci√≥n"
          autocomplete="off"
        />

        <!-- expediente -->
        <label for="expediente">Expediente</label>
        <input
          type="text"
          formControlName="expediente"
          placeholder="expediente"
          autocomplete="off"
        />

        <!-- Botones de acci√≥n -->
        <div class="botones justify-content-between">
          <button
            class="btn-sm btn-danger"
            type="button"
            (click)="eliminarReferencia(i)"
            [disabled]="referencias.length === 1"
          >
            <span [innerHTML]="removeIcon"></span>
            Eliminar
          </button>
          <button
            class="btn-sm btn-primary"
            type="button"
            (click)="agregarReferencia()"
          >
            <span [innerHTML]="addIcon"></span>
            Agregar
          </button>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n informativa -->
    <p class="info-text">
      <small>
        üí° Marca con ‚òÖ a la persona responsable. Solo una referencia puede ser
        responsable.
      </small>
    </p>
  </fieldset>

  <!-- ================ BLOQUE 6: DATOS EXTRA ESTRUCTURADO ================ -->

  <fieldset formGroupName="datos_extra" class="sub-fieldset">
    <legend>Informaci√≥n Demogr√°fica</legend>

    <div formGroupName="demograficos">
      <!-- Nacionalidad -->
      <div>
        <label for="nacionalidad">Nacionalidad</label>
        <select
          id="nacionalidad"
          formControlName="nacionalidad"
          [ngClass]="
            form.get('datos_extra.demograficos.nacionalidad')?.value
              ? 'is-valid'
              : 'is-null'
          "
        >
          <option value="">Seleccione nacionalidad</option>
          <option *ngFor="let n of paisesIso()" [value]="n.codigo_iso3">
            {{ n.nombre }}
          </option>
        </select>
      </div>

      <!-- Pueblo -->
      <div>
        <label for="pueblo">Pueblo</label>
        <select formControlName="pueblo">
          <option value="">Seleccione</option>
          <option *ngFor="let p of enums.pueblos" [value]="p.value">
            {{ p.label }}
          </option>
        </select>
      </div>

      <!-- Idioma -->
      <div>
        <label for="idioma">Idioma</label>
        <select formControlName="idioma">
          <option value="">Seleccione</option>
          <option *ngFor="let i of enums.idiomas" [value]="i.value">
            {{ i.label }}
          </option>
        </select>
      </div>

      <!-- Extranjero -->
      @if (form.get('datos_extra.demograficos.nacionalidad')?.value !== 'GTM') {
      <div>
        <label>Lugar de Nacimiento</label>
        <input type="text" formControlName="lugar_nacimiento" />
      </div>
      }

      <!-- Guatemala -->
      @if (form.get('datos_extra.demograficos.nacionalidad')?.value === 'GTM') {
      <div>
        <label>Departamento Nacimiento</label>
        <select formControlName="departamento_nacimiento">
          <option value="">Seleccione</option>
          <option *ngFor="let dep of enums.departamentos" [value]="dep.value">
            {{ dep.label }}
          </option>
        </select>
      </div>

      <div>
        <label>Municipio Nacimiento</label>
        <select formControlName="lugar_nacimiento">
          <option value="">Seleccione</option>
          <option
            *ngFor="let mun of municipios_nacimiento()"
            [value]="mun.codigo"
          >
            {{ mun.municipio }}
          </option>
        </select>
      </div>
      }

      <!-- ‚úÖ Vecindad (AQU√ç pertenece) -->
      <div>
        <label for="vecindad">Vecindado en</label>
        <select formControlName="vecindad">
          <option value="">Seleccione</option>
          <option
            *ngFor="let vecino of enums.municipios"
            [value]="vecino.codigo"
          >
            {{ vecino.codigo }} {{ vecino.departamento }},
            {{ vecino.municipio }}
          </option>
        </select>
      </div>
    </div>
  </fieldset>
  <!-- -------- SOCIOECON√ìMICOS -------- -->
  <fieldset formGroupName="datos_extra">
    <fieldset formGroupName="socioeconomicos" class="sub-fieldset">
      <legend>Informaci√≥n Socioecon√≥mica</legend>

      <!-- Estado Civil -->
      <div>
        <label for="estado_civil">Estado Civil</label>
        <select
          id="estado_civil"
          formControlName="estado_civil"
          [ngClass]="
            form.get('datos_extra.socioeconomicos.estado_civil')?.value
              ? 'is-valid'
              : 'is-null'
          "
        >
          <option value="">Seleccione</option>
          <option *ngFor="let ec of enums.estadocivil" [value]="ec.value">
            {{ ec.label }}
          </option>
        </select>
      </div>

      <!-- Ocupaci√≥n -->
      <div>
        <label for="ocupacion">Ocupaci√≥n</label>
        <input
          id="ocupacion"
          type="text"
          formControlName="ocupacion"
          placeholder="Ocupaci√≥n"
          [ngClass]="
            form.get('datos_extra.socioeconomicos.ocupacion')?.value
              ? 'is-valid'
              : 'is-null'
          "
        />
      </div>

      <!-- Nivel Educativo -->
      <div>
        <label for="educacion">Nivel Educativo</label>
        <select
          id="educacion"
          formControlName="educacion"
          [ngClass]="
            form.get('datos_extra.socioeconomicos.educacion')?.value
              ? 'is-valid'
              : 'is-null'
          "
        >
          <option value="">Seleccione</option>
          <option *ngFor="let ne of enums.gradoacademico" [value]="ne.value">
            {{ ne.label }}
          </option>
        </select>
      </div>

      <!-- Toggles -->
      <div class="d-flex gap-3">
        <!-- Estudiante P√∫blico -->
        <div class="toggle-group" style="flex: 1">
          <label>Estudiante P√∫blico</label>
          <div class="toggle-buttons">
            <button
              type="button"
              [class.active]="
                form.get('datos_extra.socioeconomicos.estudiante_publico')
                  ?.value === 'SI'
              "
              (click)="setSocio('estudiante_publico', 'SI')"
            >
              S√≠
            </button>
            <button
              type="button"
              [class.active]="
                form.get('datos_extra.socioeconomicos.estudiante_publico')
                  ?.value === 'NO'
              "
              (click)="setSocio('estudiante_publico', 'NO')"
            >
              No
            </button>
          </div>
        </div>

        <!-- Empleado P√∫blico -->
        <div class="toggle-group" style="flex: 1">
          <label>Empleado P√∫blico</label>
          <div class="toggle-buttons">
            <button
              type="button"
              [class.active]="
                form.get('datos_extra.socioeconomicos.empleado_publico')
                  ?.value === 'SI'
              "
              (click)="setSocio('empleado_publico', 'SI')"
            >
              S√≠
            </button>
            <button
              type="button"
              [class.active]="
                form.get('datos_extra.socioeconomicos.empleado_publico')
                  ?.value === 'NO'
              "
              (click)="setSocio('empleado_publico', 'NO')"
            >
              No
            </button>
          </div>
        </div>

        <!-- Discapacidad -->
        <div class="toggle-group" style="flex: 1">
          <label>Discapacidad</label>
          <div class="toggle-buttons">
            <button
              type="button"
              [class.active]="
                form.get('datos_extra.socioeconomicos.discapacidad')?.value ===
                'SI'
              "
              (click)="setSocio('discapacidad', 'SI')"
            >
              S√≠
            </button>
            <button
              type="button"
              [class.active]="
                form.get('datos_extra.socioeconomicos.discapacidad')?.value ===
                'NO'
              "
              (click)="setSocio('discapacidad', 'NO')"
            >
              No
            </button>
          </div>
        </div>
      </div>
    </fieldset>
  </fieldset>
  <!--------------- NEONATALES ------------------>
  @if (esRecienNacido()) {
  <fieldset formGroupName="datos_extra" class="sub-fieldset">
    <legend>Datos de Nacimiento (Reci√©n Nacido)</legend>

    <div formGroupName="neonatales">
      <!-- Peso de Nacimiento -->
      <div>
        <label for="peso_nacimiento">Peso Nacimiento (libras.onzas)</label>
        <input
          id="peso_nacimiento"
          type="text"
          formControlName="peso_nacimiento"
          placeholder="Ej: 3.08"
        />
      </div>

      <!-- Edad Gestacional -->
      <div>
        <label for="edad_gestacional">Edad Gestacional (semanas)</label>
        <input
          id="edad_gestacional"
          type="text"
          formControlName="edad_gestacional"
          soloNumero
          placeholder="Ej: 40"
        />
      </div>

      <!-- Tipo de Parto -->
      <div>
        <label for="parto">Tipo de Parto</label>
        <select id="parto" formControlName="parto">
          <option value="">Seleccione</option>
          <option value="P">Vaginal</option>
          <option value="C">Ces√°rea</option>
        </select>
      </div>

      <!-- N√∫mero de Gemelo -->
      <div>
        <label for="gemelo">N√∫mero de Gemelo</label>
        <input
          id="gemelo"
          type="text"
          formControlName="gemelo"
          soloNumero
          placeholder="Ej: 1"
        />
      </div>

      <!-- Expediente de la Madre -->
      <div>
        <label for="expediente_madre">Expediente de la Madre</label>
        <input
          id="expediente_madre"
          type="text"
          formControlName="expediente_madre"
          unaPalabra
          placeholder="Ej: 12345"
        />
      </div>
    </div>
  </fieldset>
  }
</form>
