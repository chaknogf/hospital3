<div class="ficha-paciente" *ngIf="paciente">
  <!-- Encabezado -->
  <header class="ficha-header">
    <div class="foto-perfil">
      <span class="avatar">{{ paciente.nombre.primer_nombre[0] }}{{ paciente.nombre.primer_apellido[0] }}</span>
    </div>
    <div class="info-header">
      <h1> {{ paciente.nombre.primer_apellido | uppercase }} {{ paciente.nombre.segundo_apellido | uppercase }} </h1>
      <p class="subtitulo">
         {{ paciente.nombre.primer_nombre | titlecase }} {{ paciente.nombre.segundo_nombre | titlecase }}
      </p>
      <p class="estado" [ngClass]="paciente.estado === 'V' ? 'vivo' : 'fallecido'">
        {{ paciente.estado === 'V' ? '🟢 Vivo' : '⚫ Fallecido' }}
        <span class="icon" [innerHTML]="paciente.estado === 'V' ? heartIcon : ghostIcon"></span>
      </p>
    </div>
    <button class="btn-volver" (click)="regresar()">
      <span [innerHTML]="regresarIcon"></span> Regresar</button>
  </header>

  <!-- Identificadores -->
  <section class="section">
    <h2>🆔 Identificación</h2>
    <div class="grid-2 section-grid">
      <div class="section-card"><label>CUI:</label> {{ paciente.cui | cui }}</div>
      <div class="section-card"><label>Expediente:</label> {{ paciente.expediente }}</div>
      <div class="section-card"><label>Pasaporte:</label> {{ paciente.pasaporte || 'No aplica' }}</div>
      <div class="section-card"><label>Otro ID:</label> {{ paciente.otro || 'N/A' }}</div>
    </div>
  </section>

  <!-- Información personal -->
  <section class="section">
    <h2>🎂 Datos Personales</h2>
    <div class="section-grid">
      <div class="section-card sexo-card"><label>Sexo:</label>
       <span class="sexo-icon" [innerHTML]="paciente.sexo === 'M' ? manIcon : womanIcon"></span>
      <p>{{ paciente.sexo === 'M' ? 'Masculino' : 'Femenino' }}</p>
      </div>
      <div class="section-card"><label>Fecha de nacimiento:</label> {{ paciente.fecha_nacimiento | date:'dd/MM/yyyy' }}</div>
      <div class="section-card"><label>Edad:</label> {{ paciente.fecha_nacimiento | edad }}</div>
     <div class="section-card" *ngIf="paciente.datos_extra?.['r11']">
  <label>Lugar de nacimiento:</label>
  {{ paciente.datos_extra?.['r11']?.valor | datosExtra:(paciente.datos_extra?.['r11']?.tipo || '') }}
</div>
    </div>
  </section>

  <!-- Contacto -->
<section class="section">
  <h2>📞 Contacto</h2>
  <div class="section-grid">
    <div class="section-card" *ngIf="paciente.contacto?.municipio">
      <label>Dirección:</label>
      <p>{{ paciente.contacto?.localidad}} {{ paciente.contacto?.municipio | datosExtra:'vecindad' }}</p>
    </div>



    <div class="section-card" *ngIf="paciente.contacto?.telefono">
      <label>Teléfono 1:</label>
      <p>
        <span *ngIf="paciente.contacto?.telefono">{{ paciente.contacto?.telefono }}</span>

      </p>
    </div>
    <div class="section-card" *ngIf="paciente.contacto?.telefono2">
      <label>Teléfono 2:</label>
      <p>

        <span *ngIf="paciente.contacto?.telefono2">{{ paciente.contacto?.telefono2 }}</span>

      </p>
    </div>
    <div class="section-card" *ngIf="paciente.contacto?.telefono3">
      <label>Teléfono 3:</label>
      <p>
        <span *ngIf="paciente.contacto?.telefono3">{{ paciente.contacto?.telefono3 }}</span>
      </p>
    </div>
  </div>
</section>

  <!-- Referencias -->
  <section class="section" *ngIf="referenciaKeys.length">
    <h2>👥 Referencias</h2>
    <div class="section-grid grid-3">
      <div class="section-card" *ngFor="let key of referenciaKeys" class="card-mini">
        <label>Nombre:</label><p> {{ paciente.referencias?.[key]?.nombre }}</p>
        <label>Parentesco:</label> <p>{{ paciente.referencias?.[key]?.parentesco |datosExtra: 'parentesco'}}</p>
        <label>Teléfono:</label><p> {{ paciente.referencias?.[key]?.telefono }}</p>
      </div>
    </div>
  </section>

  <!-- Datos Extra -->
 <section class="section" *ngIf="datosExtraFiltrados.length">
  <h2>📄 Datos Extra</h2>
  <div class="section-grid grid-3">
    <div class="section-card " *ngFor="let dato of datosExtraFiltrados">
      <p class="card-mini"><label>{{ convertirTipo(dato.tipo) }}:</label></p>
      <p>{{ dato.valor | datosExtra:dato.tipo }}</p>
    </div>
  </div>
</section>

  <!-- Metadatos -->
  <section class="section">
    <h2>📌 Historial de cambios</h2>
    <ul class="timeline">
      <li *ngFor="let key of metadatosKeys">
        <span class="usuario">{{ paciente.metadatos?.[key]?.usuario }}</span>
        <span class="fecha">{{ paciente.metadatos?.[key]?.registro | date:'medium' }}</span>
      </li>
    </ul>
  </section>
</div>
